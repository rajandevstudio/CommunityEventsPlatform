{% extends "frontend/base.html" %}

{% block content %}
<div class="flex items-center justify-center min-h-[calc(100vh-4rem)]">
  <div class="bg-white p-8 rounded-xl shadow-lg w-full max-w-md">
    <h2 class="text-2xl font-bold mb-6 text-center">
      Login
    </h2>

    <input
      id="username"
      placeholder="Username"
      class="w-full mb-4 px-4 py-2 border rounded focus:outline-none focus:ring focus:ring-blue-300"
    />

    <input
      id="password"
      type="password"
      placeholder="Password"
      class="w-full mb-6 px-4 py-2 border rounded focus:outline-none focus:ring focus:ring-blue-300"
    />

    <button
      id="login-btn"
      onclick="handleLogin()"
      class="w-full bg-blue-600 text-white py-2 rounded hover:bg-blue-700 transition"
    >
      Login
    </button>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
async function handleLogin() {
  const btn = document.getElementById("login-btn");
  btn.disabled = true;
  btn.innerText = "Logging in...";

  try {
    const tokenData = await apiFetch("/api/v1/web-auth/", {
      method: "POST",
      body: JSON.stringify({
        username: username.value,
        password: password.value,
      }),
    });

    localStorage.setItem("access_token", tokenData.access);

    // Fetch user data
    const userData = await apiFetch("/api/v1/users/");

    if (userData && userData.results.length > 0 ) {
      localStorage.setItem("currentUser", JSON.stringify(userData.results[0]));
    }

    showToast("Welcome back!", "success");

    setTimeout(() => {
      window.location.href = "/playground/events/";
    }, 800);

  } catch (error) {
    btn.disabled = false;
    btn.innerText = "Login";
    localStorage.removeItem("access_token");
    localStorage.removeItem("currentUser");
    showToast(error.message || "Invalid username or password", "error");
  }
}
</script>
{% endblock %}
